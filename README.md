# VietShort - Ná»n Táº£ng Xem Phim Trá»±c Tuyáº¿n ğŸ¬

Má»™t á»©ng dá»¥ng xem phim trá»±c tuyáº¿n hiá»‡n Ä‘áº¡i vá»›i há»‡ thá»‘ng hoa há»“ng CTV, quáº£n lÃ½ VIP vÃ  thanh toÃ¡n IAP. Há»— trá»£ Ä‘a ná»n táº£ng: Web, Android, iOS.

---

## ğŸ“‹ Má»¥c Lá»¥c

- [Tá»•ng Quan](#tá»•ng-quan)
- [CÃ¡c TÃ­nh NÄƒng ChÃ­nh](#cÃ¡c-tÃ­nh-nÄƒng-chÃ­nh)
- [Tech Stack](#tech-stack)
- [Kiáº¿n TrÃºc Há»‡ Thá»‘ng](#kiáº¿n-trÃºc-há»‡-thá»‘ng)
- [Lá»™ TrÃ¬nh Triá»ƒn Khai](#lá»™-trÃ¬nh-triá»ƒn-khai)
- [HÆ°á»›ng Dáº«n CÃ i Äáº·t](#hÆ°á»›ng-dáº«n-cÃ i-Ä‘áº·t)
- [Cáº¥u HÃ¬nh Triá»ƒn Khai](#cáº¥u-hÃ¬nh-triá»ƒn-khai)
- [CÃ¡c ThÃ¡ch Thá»©c Ká»¹ Thuáº­t](#cÃ¡c-thÃ¡ch-thá»©c-ká»¹-thuáº­t)

---

## ğŸ¯ Tá»•ng Quan

**VietShort** lÃ  ná»n táº£ng streaming phim vá»›i:
- **10.000+ users/day** (tiá»m nÄƒng cao)
- Doanh thu tá»«: náº¡p tiá»n, Ä‘Äƒng kÃ½ VIP, quáº£ng cÃ¡o
- Äá»™ phá»©c táº¡p cao vá» backend (tiá»n, unlock, thanh toÃ¡n)
- Há»— trá»£ khÃ¡ch vÃ£ng lai (guest user)
- Quáº£n lÃ½ hoa há»“ng CTV (affiliate)

---

## âœ¨ CÃ¡c TÃ­nh NÄƒng ChÃ­nh

### 1ï¸âƒ£ **ÄÄƒng KÃ½ / ÄÄƒng Nháº­p**
- âœ” ÄÄƒng nháº­p email/máº­t kháº©u
- âœ” OAuth: Google, Apple, Facebook, TikTok
- âœ” KhÃ¡ch vÃ£ng lai (guest mode)
- âœ” QuÃªn máº­t kháº©u / Äáº·t láº¡i máº­t kháº©u
- âœ” XÃ¡c thá»±c 2 yáº¿u tá»‘ (2FA) - *NÃ¢ng cao*

### 2ï¸âƒ£ **Trang Chá»§**
- **Banner Ä‘á»™ng**: Cuá»™n áº£nh, cáº¥u hÃ¬nh Ä‘iá»u hÆ°á»›ng phim/link ngoÃ i
- **Äá» xuáº¥t chÃ­nh**: Phim Ä‘Æ°á»£c cáº¥u hÃ¬nh tá»« backend
- **BXH Thá»‹nh hÃ nh**: Dá»±a trÃªn Ä‘á»™ hot (view, like, share)
- **Phim Ä‘Ã£ káº¿t thÃºc**: Danh sÃ¡ch phim hoÃ n thÃ nh
- **Lá»c theo thá»ƒ loáº¡i**: TiÃªn hiá»‡p, XuyÃªn khÃ´ng, Trá»ng sinh, v.v.

### 3ï¸âƒ£ **Báº£ng Xáº¿p Háº¡ng**
- BXH phim má»›i (sáº¯p xáº¿p theo ngÃ y lÃªn sÃ³ng)
- BXH thá»‹nh hÃ nh (sáº¯p xáº¿p theo Ä‘á»™ hot)

### 4ï¸âƒ£ **Danh SÃ¡ch Phim**
- Gá»£i Ã½ dá»±a trÃªn lá»‹ch sá»­ xem
- Lá»c theo thá»ƒ loáº¡i
- VIP Ä‘á»™c quyá»n (chá»‰ VIP unlock)

### 5ï¸âƒ£ **Xem Phim**
- **Äiá»u khiá»ƒn video**:
  - Vuá»‘t lÃªn/xuá»‘ng: chuyá»ƒn táº­p
  - Chuyá»ƒn Ä‘á»™ phÃ¢n giáº£i: TiÃªu chuáº©n, HD, SiÃªu nÃ©t
  - Thay Ä‘á»•i tá»‘c Ä‘á»™: 0.5x, 1.0x, 1.5x, 2.0x
  - Nháº¥n giá»¯: Tá»‘c Ä‘á»™ 2x
  - Cháº¿ Ä‘á»™ Ä‘áº¯m chÃ¬m: áº¨n/hiá»‡n thanh Ä‘iá»u khiá»ƒn
- **TÆ°Æ¡ng tÃ¡c**:
  - Like / Unlike
  - SÆ°u táº§m
  - BÃ¬nh luáº­n
  - Chia sáº»
  - ÄÃ¡nh giÃ¡ (1-5 sao)
- **Má»Ÿ khÃ³a**:
  - DÃ¹ng tiá»n vÃ ng
  - Xem quáº£ng cÃ¡o
  - Má»Ÿ khÃ³a toÃ n bá»™ phim

### 6ï¸âƒ£ **PhÃºc Lá»£i**
- **Äiá»ƒm danh hÃ ng ngÃ y** (7 ngÃ y 1 chu ká»³):
  - Nháº­n tiá»n vÃ ng
  - Xem quáº£ng cÃ¡o = nháº­n gáº¥p Ä‘Ã´i
- **Nhiá»‡m vá»¥ hÃ ng ngÃ y**: Xem phim, xem ads, like, v.v.
- **Nhiá»‡m vá»¥ má»™t láº§n**: Follow FB/INS, bÃ¬nh luáº­n láº§n Ä‘áº§u
- **Cáº¥u hÃ¬nh linh hoáº¡t tá»« backend**

### 7ï¸âƒ£ **Trang "Cá»§a TÃ´i"**
- Thay Ä‘á»•i avatar
- Thay Ä‘á»•i biá»‡t danh
- Xem thÃ´ng tin VIP
- Quáº£n lÃ½ Ä‘Äƒng nháº­p (liÃªn káº¿t nhiá»u tÃ i khoáº£n)
- Náº¡p tiá»n vÃ ng
- Lá»‹ch sá»­ xem phim

### 8ï¸âƒ£ **Giá»¯ ChÃ¢n KhÃ¡ch HÃ ng**
- Popup giáº£m giÃ¡ khi xem báº£ng giÃ¡ chÆ°a thanh toÃ¡n
- Äáº¿m ngÆ°á»£c 2 phÃºt - tá»± Ä‘á»™ng giáº£m giÃ¡
- Push notification tá»« á»©ng dá»¥ng

### 9ï¸âƒ£ **Backend Admin**

#### Quáº£n LÃ½ Ná»™i Dung
- Quáº£n lÃ½ phim: thÃªm, sá»­a, xÃ³a, batch upload
- Tá»± Ä‘á»™ng transcode (480P, 720P, 1080P) â†’ M3u8
- Batch upload phá»¥ Ä‘á» (SRT)
- Dá»‹ch phá»¥ Ä‘á» tá»± Ä‘á»™ng (Google Translate)
- Quáº£n lÃ½ danh sÃ¡ch phim
- Quáº£n lÃ½ trailer
- Cáº¥u hÃ¬nh phÃ¢n loáº¡i (thá»ƒ loáº¡i, ngÃ´n ngá»¯)

#### Quáº£n LÃ½ Quyá»n Háº¡n
- Quáº£n lÃ½ admin: thÃªm, sá»­a, xÃ³a
- Nháº­t kÃ½ hoáº¡t Ä‘á»™ng admin
- NhÃ³m vai trÃ² & phÃ¢n quyá»n
- Menu rules

#### Quáº£n LÃ½ ThÃ nh ViÃªn
- Xem: khu vá»±c, biá»‡t danh, giá»›i tÃ­nh, sá»‘ dÆ°, VIP status
- Sá»­a tiá»n vÃ ng
- Cáº¥p VIP
- Xem ngÆ°á»i dÃ¹ng trá»±c tiáº¿p/giÃ¡n tiáº¿p
- PhÃ¢n tá»• thÃ nh viÃªn

#### Quáº£n LÃ½ CTV (Affiliate)
- ThÃªm, sá»­a, xÃ³a CTV
- Cáº¥u hÃ¬nh tÃ i khoáº£n CTV
- Xem: mÃ£ CTV, tá»· lá»‡ hoa há»“ng, click, Ä‘Æ¡n, doanh thu
- Quáº£n lÃ½ rÃºt tiá»n

#### Quáº£n LÃ½ Nháº­t KÃ½
- Nháº­t kÃ½ tiá»n vÃ ng (tÃ¬m theo ID/biá»‡t danh)
- Nháº­t kÃ½ unlock phim (tiá»n vÃ ng / quáº£ng cÃ¡o)
- Nháº­t kÃ½ Ä‘iá»ƒm danh
- Lá»‹ch sá»­ xem phim (chÃ­nh xÃ¡c Ä‘áº¿n giÃ¢y)
- Nháº­t kÃ½ thay Ä‘á»•i thÃ´ng tin

#### Quáº£n LÃ½ MÃ£ Äá»•i
- Táº¡o batch mÃ£ tiá»n vÃ ng / VIP
- Cáº¥u hÃ¬nh thá»i gian, sá»‘ lÆ°á»£ng, Ä‘á»™ dÃ i
- Xuáº¥t Excel
- TÃ¬nh hÃ¬nh sá»­ dá»¥ng
- Truy váº¥n mÃ£

#### Trung TÃ¢m TÃ i ChÃ­nh
- Thá»‘ng kÃª: tá»•ng náº¡p, users, Ä‘Æ¡n, biá»ƒu Ä‘á»“
- Cáº¥u hÃ¬nh náº¡p tiá»n (máº«u mua)
- Nháº­t kÃ½ náº¡p tiá»n toÃ n há»‡ thá»‘ng
- Cáº¥u hÃ¬nh giá»¯ chÃ¢n khÃ¡ch (flash sale, countdown)

#### Quáº£n LÃ½ Nhiá»‡m Vá»¥
- Cáº¥u hÃ¬nh linh hoáº¡t nhiá»‡m vá»¥ hÃ ng ngÃ y
- Cáº¥u hÃ¬nh nhiá»‡m vá»¥ má»™t láº§n

---

## ğŸ› ï¸ Tech Stack

### **Frontend Web**
```
Framework: Next.js 14+ (React)
Styling: TailwindCSS
Video Player: HLS.js
State Management: React Query (TanStack Query)
Authentication: next-auth
SEO: next-seo
i18n: next-i18n-router / i18next
CDN: Cloudflare (Image Optimization)
Deployment: Cloudflare Pages
```

### **Backend API**
```
Runtime: Node.js 18+
Framework: NestJS
Database: MySQL 8.0+
Cache: Redis 6.0+
Authentication: JWT + Session
ORM: TypeORM / Prisma
Queue: Bull / BullMQ (video transcode, notifications)
Storage: Cloudflare R2
Payment: IAP SDK (iOS/Android), Momo/VNPay (Web)
Deployment: VPS (Ubuntu 20.04+)
```

### **Infra & Security**
```
CDN: Cloudflare CDN
DDoS: Cloudflare DDoS Protection
WAF: Cloudflare Web Application Firewall
Bot Management: Cloudflare Bot Management
SSL: Cloudflare SSL (Full / Full Strict)
Rate Limiting: Cloudflare Rate Limiting + Backend
Anti Hotlink: Cloudflare + Signed URLs
Video Streaming: HLS (.m3u8 + .ts)
```

### **Mobile (Roadmap Giai Äoáº¡n 2)**
```
Android: React Native
iOS: React Native
IAP: App Store / Google Play Billing
```

---

## ğŸ—ï¸ Kiáº¿n TrÃºc Há»‡ Thá»‘ng

```
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚  Cloudflare DNS â”‚
                            â”‚  (domain.com)   â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                â”‚                â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ www.domain.com    â”‚ â”‚api.domain.com â”‚ â”‚v.domain.com    â”‚
         â”‚ (Frontend)        â”‚ â”‚ (Backend API) â”‚ â”‚(Video CDN)     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                 â”‚               â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚               â”‚
       â”‚ Cloudflare Pages    â”‚     â”‚               â”‚
       â”‚ + Cloudflare CDN    â”‚     â”‚               â”‚
       â”‚ + Image Opt         â”‚     â”‚               â”‚
       â”‚                     â”‚     â”‚               â”‚
       â”‚ Next.js SPA         â”‚     â”‚               â”‚
       â”‚ (HTML/CSS/JS)       â”‚     â”‚               â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚               â”‚
                                   â”‚               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”          â”‚
                    â”‚                   â”‚          â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”‚
         â”‚  VPS Backend        â”‚ â”‚ Cloudflare  â”‚  â”‚
         â”‚                     â”‚ â”‚ R2 Storage  â”‚â”€â”€â”˜
         â”‚ NestJS API          â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ MySQL               â”‚
         â”‚ Redis               â”‚
         â”‚                     â”‚
         â”‚ âœ” JWT/Session Auth  â”‚
         â”‚ âœ” Video Transcode   â”‚
         â”‚ âœ” Queue (Bull)      â”‚
         â”‚ âœ” Payment Handling  â”‚
         â”‚ âœ” Webhook IAP       â”‚
         â”‚                     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ CORS allowed from:
                    â”‚ - www.domain.com
                    â”‚ - v.domain.com
                    â””â”€ Cloudflare IP only
```

### **Lá»›p Báº£o Máº­t (Cloudflare)**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User Request                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Cloudflare DDoS    â”‚
        â”‚  Protection         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Cloudflare WAF     â”‚
        â”‚  + Bot Management   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Cloudflare Rate    â”‚
        â”‚  Limiting           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Firewall Rules     â”‚
        â”‚  + Anti Hotlink     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Origin (Your VPS)  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ Lá»™ TrÃ¬nh Triá»ƒn Khai

### **Phase 1: Website (2-3 thÃ¡ng)** âœ… HIá»†N Táº I

#### ThÃ¡ng 1: Khá»Ÿi Äá»™ng & Backend
```
Week 1-2:
  âœ” Setup infrastructure (VPS, Cloudflare)
  âœ” Setup databases (MySQL, Redis)
  âœ” Create NestJS backend project structure
  
Week 3-4:
  âœ” Auth module (Register, Login, JWT, OAuth)
  âœ” User profile management
  âœ” Database schema design
  âœ” Video management API (CRUD, batch upload)
```

#### ThÃ¡ng 2: Core Features
```
Week 1-2:
  âœ” Video streaming API (HLS, token validation)
  âœ” Video transcode queue (FFmpeg â†’ M3u8)
  âœ” Payment system (tiá»n vÃ ng, transactions)
  âœ” Unlock mechanism (video, episode)
  
Week 3-4:
  âœ” Admin panel API routes
  âœ” Logging & audit system
  âœ” CTV affiliate system
  âœ” Task & reward system
```

#### ThÃ¡ng 3: Frontend & Polish
```
Week 1-2:
  âœ” Frontend repo setup (Next.js + Tailwind)
  âœ” Homepage + Video player (HLS.js)
  âœ” Auth pages (Login, Register)
  âœ” User profile pages
  
Week 3-4:
  âœ” Admin dashboard
  âœ” Video management UI
  âœ” Testing & QA
  âœ” Deploy to Cloudflare Pages + VPS
```

### **Phase 2: Mobile Apps (2-3 thÃ¡ng)**
```
Month 1:
  âœ” React Native project setup
  âœ” iOS IAP integration
  âœ” Android Play Billing integration
  
Month 2-3:
  âœ” Port Web features to mobile
  âœ” Performance optimization
  âœ” Testing & release
```

### **Phase 3: Advanced Features**
```
  âœ” Ads network integration (Google Ads)
  âœ” Notification system (push notifications)
  âœ” Analytics & tracking
  âœ” Machine learning recommendations
```

---

## ğŸ”§ HÆ°á»›ng Dáº«n CÃ i Äáº·t

### **1. YÃªu Cáº§u Há»‡ Thá»‘ng**
```bash
Node.js: v18.0.0 or higher
npm: v9.0.0 or higher
MySQL: v8.0.0 or higher
Redis: v6.0.0 or higher
FFmpeg: v5.0.0 or higher (video transcode)
```

### **2. Clone & Setup**
```bash
# Clone repo
git clone https://github.com/yourusername/vietshort.git
cd vietshort

# CÃ i Ä‘áº·t dependencies
npm install

# Copy env files
cp .env.example .env
cp .env.example .env.local
```

### **3. Database Setup**
```bash
# MySQL
mysql -u root -p
CREATE DATABASE vietshort;
CREATE USER 'vietshort'@'localhost' IDENTIFIED BY 'password';
GRANT ALL PRIVILEGES ON vietshort.* TO 'vietshort'@'localhost';

# Run migrations
npm run migration:run
```

### **4. Environment Variables**

**Backend (.env)**
```env
# Database
DATABASE_HOST=localhost
DATABASE_PORT=3306
DATABASE_USER=vietshort
DATABASE_PASSWORD=password
DATABASE_NAME=vietshort

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# JWT
JWT_SECRET=your-secret-key
JWT_EXPIRATION=7d

# OAuth
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=

APPLE_CLIENT_ID=
APPLE_CLIENT_SECRET=

FACEBOOK_APP_ID=
FACEBOOK_APP_SECRET=

# Payment
STRIPE_SECRET_KEY=
STRIPE_PUBLIC_KEY=

VNPAY_MERCHANT_ID=
VNPAY_SECRET_KEY=

# Cloudflare R2
CLOUDFLARE_ACCOUNT_ID=
CLOUDFLARE_ACCESS_KEY_ID=
CLOUDFLARE_SECRET_ACCESS_KEY=
CLOUDFLARE_BUCKET_NAME=

# Video
FFMPEG_PATH=/usr/bin/ffmpeg
MAX_VIDEO_SIZE=5000 # MB
ALLOWED_VIDEO_FORMATS=mp4,mkv,avi

# Email (for password reset)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=
SMTP_PASSWORD=

# App
NODE_ENV=development
PORT=3000
API_URL=http://localhost:3000
FRONTEND_URL=http://localhost:3000
```

**Frontend (.env.local)**
```env
NEXT_PUBLIC_API_URL=http://localhost:3000/api
NEXT_PUBLIC_VIDEO_CDN=http://localhost:3000/video

# OAuth
NEXT_PUBLIC_GOOGLE_CLIENT_ID=
NEXT_PUBLIC_APPLE_CLIENT_ID=
NEXT_PUBLIC_FACEBOOK_APP_ID=
```

### **5. Cháº¡y Development**

**Backend**
```bash
cd backend
npm run dev
# Server: http://localhost:3000
```

**Frontend**
```bash
cd frontend
npm run dev
# App: http://localhost:3000
```

---

## ğŸŒ Cáº¥u HÃ¬nh Triá»ƒn Khai

### **1ï¸âƒ£ Domain & DNS (Cloudflare)**

```
TÃªn miá»n: yourdomain.com (hoáº·c .xyz, .site, .tv)

Subdomains:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ www.yourdomain.com â†’ Frontend          â”‚
â”‚ api.yourdomain.com â†’ Backend API       â”‚
â”‚ v.yourdomain.com   â†’ Video CDN         â”‚
â”‚ admin.yourdomain.com â†’ Admin Panel     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

DNS Records:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Name         â”‚ Type         â”‚ Value             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ @            â”‚ A / CNAME    â”‚ Cloudflare Pages  â”‚
â”‚ www          â”‚ CNAME        â”‚ pages.cloudflare  â”‚
â”‚ api          â”‚ A / CNAME    â”‚ Your VPS IP       â”‚
â”‚ v            â”‚ CNAME        â”‚ r2.yourdomain.com â”‚
â”‚ admin        â”‚ CNAME        â”‚ pages.cloudflare  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **2ï¸âƒ£ Cloudflare Security Setup**

**SSL/TLS**
```
Mode: Full (Strict)
Min TLS Version: 1.2
Always Use HTTPS: ON
HSTS: Enable (max-age=31536000)
```

**WAF Rules**
```
âœ” Enable Cloudflare Managed Rules
âœ” OWASP Core Rule Set
âœ” Cloudflare Bot Management
âœ” Rate Limiting:
  - 100 requests per 10 seconds per IP
  - 1000 requests per minute per user (JWT)

âœ” Firewall Rules:
  - Block VPN/Proxy (if needed)
  - GeoIP blocking (optional)
  - Custom rules for API endpoints
```

**Cache Rules**
```
Frontend (www.yourdomain.com):
  - Cache HTML: 1 hour
  - Cache JS/CSS: 30 days
  - Cache Images: 1 year
  
Video (v.yourdomain.com):
  - Cache M3u8: 10 minutes
  - Cache TS segments: 1 year
  - Signed URLs for security
```

**Anti Hotlink**
```
Referrer Policy: Strict
Allowed Referrers:
  - yourdomain.com
  - app.yourdomain.com
  - localhost (development)
```

### **3ï¸âƒ£ VPS Backend Deployment**

**Server Setup (Ubuntu 20.04 LTS)**
```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Install Node.js 18
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# Install MySQL 8
sudo apt-get install -y mysql-server

# Install Redis
sudo apt-get install -y redis-server

# Install FFmpeg
sudo apt-get install -y ffmpeg

# Install Nginx (reverse proxy)
sudo apt-get install -y nginx

# Install PM2
sudo npm install -g pm2

# Install Docker (optional for containers)
sudo apt-get install -y docker.io
```

**Nginx Config** (`/etc/nginx/sites-available/default`)
```nginx
upstream backend {
    server localhost:3000;
    keepalive 64;
}

upstream video {
    server r2.yourdomain.com;
}

# Rate limiting
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=30r/s;
limit_req_zone $http_x_forwarded_for zone=cf_limit:10m rate=100r/s;

server {
    listen 443 ssl http2;
    server_name api.yourdomain.com;

    # SSL from Let's Encrypt + Cloudflare
    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;

    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # CORS (for frontend only)
    add_header Access-Control-Allow-Origin "https://www.yourdomain.com" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;

    # Rate limiting
    limit_req zone=api_limit burst=50 nodelay;
    limit_req zone=cf_limit burst=200 nodelay;

    # Only allow Cloudflare IPs
    set $cloudflare_ips "103.21.244.0/22 103.22.200.0/22 103.31.4.0/22";
    
    location / {
        # Verify Cloudflare
        if ($http_cf_connecting_ip = "") {
            return 403;
        }

        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    location /video {
        proxy_pass https://video.yourdomain.com;
        proxy_ssl_verify off;
    }
}

# Redirect HTTP to HTTPS
server {
    listen 80;
    server_name api.yourdomain.com;
    return 301 https://$server_name$request_uri;
}
```

**Deploy Backend**
```bash
# SSH to VPS
ssh root@your.vps.ip

# Clone repo
git clone https://github.com/yourusername/vietshort.git
cd vietshort/backend

# Install dependencies
npm install

# Setup environment
cp .env.example .env
# Edit .env with production values

# Run migrations
npm run migration:run

# Build
npm run build

# Start with PM2
pm2 start dist/main.js --name "vietshort-api"
pm2 startup
pm2 save

# Check status
pm2 logs vietshort-api
pm2 monit
```

### **4ï¸âƒ£ Frontend Deploy (Cloudflare Pages)**

**Using GitHub Actions**
```bash
# 1. Push to GitHub
git init
git add .
git commit -m "Initial commit"
git remote add origin https://github.com/yourusername/vietshort-frontend.git
git push -u origin main

# 2. Connect to Cloudflare Pages
# Go to Cloudflare Dashboard
# Pages â†’ Connect to Git
# Select repo â†’ yourdomain.com
# Production branch: main

# Build settings:
# Framework preset: Next.js
# Build command: npm run build
# Build output directory: .next
# Root directory: /frontend

# 3. Add Environment Variables
# In Cloudflare Pages â†’ Settings â†’ Environment Variables
NEXT_PUBLIC_API_URL=https://api.yourdomain.com
NEXT_PUBLIC_VIDEO_CDN=https://v.yourdomain.com
```

**Deploy Command (CLI)**
```bash
# Install Wrangler
npm install -g wrangler

# Login
wrangler login

# Deploy
npm run build
wrangler pages publish out --project-name=vietshort
```

### **5ï¸âƒ£ Cloudflare R2 Setup** (Video Storage)

```bash
# Create bucket via Cloudflare Dashboard
Bucket Name: videos-yourdomain

# Create API token
Cloudflare Dashboard â†’ Account Settings â†’ API Tokens
Scope: R2 Read/Write

# Configure backend
R2_ACCOUNT_ID=xxx
R2_ACCESS_KEY_ID=xxx
R2_SECRET_ACCESS_KEY=xxx
R2_BUCKET_NAME=videos-yourdomain
R2_PUBLIC_URL=https://videos-yourdomain.r2.yourdomain.com
```

**Upload to R2**
```javascript
// backend/src/services/storage.service.ts
import { S3Client, PutObjectCommand } from "@aws-sdk/client-s3";

const s3Client = new S3Client({
  region: "auto",
  credentials: {
    accessKeyId: process.env.R2_ACCESS_KEY_ID,
    secretAccessKey: process.env.R2_SECRET_ACCESS_KEY,
  },
  endpoint: `https://${process.env.R2_ACCOUNT_ID}.r2.cloudflarestorage.com`,
});

export async function uploadToR2(
  bucketName: string,
  key: string,
  body: Buffer
) {
  const command = new PutObjectCommand({
    Bucket: bucketName,
    Key: key,
    Body: body,
    ContentType: "application/octet-stream",
  });

  return s3Client.send(command);
}
```

### **6ï¸âƒ£ Database Backup & Monitoring**

**MySQL Backup (Daily)**
```bash
# Create backup script: /home/backup-mysql.sh
#!/bin/bash
BACKUP_DIR="/backups/mysql"
DATE=$(date +%Y%m%d_%H%M%S)
FILENAME="vietshort_$DATE.sql.gz"

mysqldump -u vietshort -p$DB_PASSWORD vietshort | gzip > $BACKUP_DIR/$FILENAME

# Keep only 7 days backup
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

# Add to crontab (run daily at 2 AM)
crontab -e
# Add: 0 2 * * * /home/backup-mysql.sh
```

**Monitoring**
```bash
# Install Cloudflare Analytics
# Cloudflare Dashboard â†’ Analytics
# Monitor: Traffic, Cache Hit Ratio, Errors

# PM2 Monitoring
pm2 web
# Access: http://localhost:9615

# VPS Monitoring (optional)
sudo apt-get install htop iotop nethogs
```

---

## âš ï¸ CÃ¡c ThÃ¡ch Thá»©c Ká»¹ Thuáº­t

### **1. Atomic Tiá»n & Unlock** ğŸ”’
```
Váº¥n Ä‘á»: TrÃ¡nh double-charge khi cÃ³ network lag
Giáº£i phÃ¡p:
  âœ” Database transaction (MySQL)
  âœ” Idempotency key (duplicate detection)
  âœ” Webhook validation
  âœ” Retry logic with exponential backoff

VÃ­ dá»¥:
  1. Client request unlock video (100 gold)
  2. Backend check balance
  3. Deduct in transaction (atomic)
  4. Return signed token
  5. Client cache token locally
  6. If fail, retry with same idempotency key
```

### **2. Thanh ToÃ¡n IAP** ğŸ’³
```
iOS:
  âœ” App Store Server API v2
  âœ” Transaction receipt validation
  âœ” Webhook: app.transaction event
  âœ” Refund handling

Android:
  âœ” Google Play Billing Library v7+
  âœ” Purchase token validation
  âœ” Real-time Developer Notifications
  âœ” Subscription state tracking

Backend:
  âœ” Validate receipt with Apple/Google
  âœ” Update user balance
  âœ” Handle refunds
  âœ” Log all transactions
  âœ” Reconciliation process (daily)
```

### **3. Ads Callback** ğŸ“º
```
Flow:
  1. Frontend request ad to AdNetwork (Google Ads, Facebook)
  2. User watches ad
  3. AdNetwork callback to backend
  4. Backend verify callback (signature)
  5. Grant reward to user
  6. Return success to AdNetwork

Implementation:
  âœ” Webhook signature verification
  âœ” Idempotency key for duplicates
  âœ” Timeout handling
  âœ” Fraud detection (impossible rewards)
```

### **4. Logging & Reconciliation** ğŸ“Š
```
Cáº§n track:
  âœ” Má»—i transaction tiá»n vÃ ng (user, amount, reason)
  âœ” Má»—i láº§n unlock (user, video, method)
  âœ” Má»—i láº§n xem quáº£ng cÃ¡o (user, ad_id, reward)
  âœ” Má»—i thanh toÃ¡n IAP (user, product, receipt)
  âœ” Má»—i withdrawal CTV (ctv, amount, bank)

Reconciliation (Daily):
  âœ” Check IAP receipts with Apple/Google
  âœ” Check Stripe transactions
  âœ” Verify ad rewards
  âœ” Audit gold balance
  âœ” Generate reports
```

### **5. Video Streaming** ğŸ¥
```
HLS (HTTP Live Streaming):
  âœ” Segment multiple bitrates (480p, 720p, 1080p)
  âœ” Generate M3u8 playlist
  âœ” Serve via CDN
  âœ” Signed URLs (expire after 1 hour)
  âœ” Referrer check (prevent hotlink)

Transcode Pipeline:
  1. Upload video
  2. Queue transcode job
  3. FFmpeg process (480p, 720p, 1080p)
  4. Upload segments to R2
  5. Generate M3u8
  6. Update DB
  7. Cleanup local files

Performance:
  âœ” Parallel transcode (using Bull queue)
  âœ” Progressive upload (don't wait for all)
  âœ” Cloudflare R2 caching
```

---

## ğŸ“¦ Project Structure

```
vietshort/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.controller.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ jwt.strategy.ts
â”‚   â”‚   â”‚   â””â”€â”€ oauth/
â”‚   â”‚   â”œâ”€â”€ users/
â”‚   â”‚   â”œâ”€â”€ videos/
â”‚   â”‚   â”‚   â”œâ”€â”€ video.controller.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ video.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ transcode.service.ts
â”‚   â”‚   â”‚   â””â”€â”€ hls.service.ts
â”‚   â”‚   â”œâ”€â”€ payment/
â”‚   â”‚   â”‚   â”œâ”€â”€ gold.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ vip.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ iap.service.ts
â”‚   â”‚   â”‚   â””â”€â”€ unlock.service.ts
â”‚   â”‚   â”œâ”€â”€ admin/
â”‚   â”‚   â”œâ”€â”€ ctv/
â”‚   â”‚   â”œâ”€â”€ tasks/
â”‚   â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â”‚   â”œâ”€â”€ decorators/
â”‚   â”‚   â”‚   â”œâ”€â”€ guards/
â”‚   â”‚   â”‚   â”œâ”€â”€ pipes/
â”‚   â”‚   â”‚   â””â”€â”€ filters/
â”‚   â”‚   â”œâ”€â”€ database/
â”‚   â”‚   â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”‚   â””â”€â”€ migrations/
â”‚   â”‚   â””â”€â”€ main.ts
â”‚   â”œâ”€â”€ .env.example
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ tsconfig.json
â”‚   â””â”€â”€ docker-compose.yml
â”‚
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx (homepage)
â”‚   â”‚   â”‚   â”œâ”€â”€ watch/[id].tsx (video player)
â”‚   â”‚   â”‚   â”œâ”€â”€ auth/login.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ admin/ (admin dashboard)
â”‚   â”‚   â”‚   â””â”€â”€ api/ (API routes)
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ VideoPlayer.tsx (HLS.js)
â”‚   â”‚   â”‚   â”œâ”€â”€ Navigation.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Banner.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ VideoCard.tsx
â”‚   â”‚   â”‚   â””â”€â”€ shared/
â”‚   â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”‚   â”œâ”€â”€ useAuth.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ useUser.ts
â”‚   â”‚   â”‚   â””â”€â”€ useVideo.ts
â”‚   â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”‚   â”œâ”€â”€ api.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.ts
â”‚   â”‚   â”‚   â””â”€â”€ hls.ts
â”‚   â”‚   â”œâ”€â”€ styles/
â”‚   â”‚   â””â”€â”€ env.d.ts
â”‚   â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ .env.local.example
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ tsconfig.json
â”‚   â”œâ”€â”€ next.config.js
â”‚   â””â”€â”€ tailwind.config.js
â”‚
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ setup-db.sql
â”‚   â”œâ”€â”€ deploy-vps.sh
â”‚   â”œâ”€â”€ backup-mysql.sh
â”‚   â””â”€â”€ transcode-video.sh
â”‚
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ API.md (API documentation)
â”‚   â”œâ”€â”€ DEPLOYMENT.md (this file)
â”‚   â”œâ”€â”€ ARCHITECTURE.md
â”‚   â””â”€â”€ TESTING.md
â”‚
â””â”€â”€ README.md (this file)
```

---

## ğŸ§ª Testing & QA

### **Unit Tests**
```bash
# Backend
npm run test:unit

# Frontend
npm run test
```

### **Integration Tests**
```bash
npm run test:integration
```

### **E2E Tests**
```bash
npm run test:e2e
```

### **Load Testing**
```bash
# Using k6 or Apache JMeter
k6 run load-test.js
```

---

## ğŸ“ˆ Monitoring & Logging

### **Backend Logs**
```bash
# PM2 logs
pm2 logs vietshort-api

# Cloudflare Analytics
# Dashboard â†’ Analytics & Logs
```

### **Error Tracking** (Optional)
```bash
npm install @sentry/node
# Configure in backend/src/main.ts
```

### **Database Monitoring**
```bash
mysql -u vietshort -p
SHOW PROCESSLIST;
SHOW STATUS;
```

---

## ğŸ”’ Security Checklist

- [ ] Enable HTTPS everywhere (Cloudflare SSL)
- [ ] Rate limiting configured (API & Cloudflare)
- [ ] WAF rules enabled
- [ ] DDoS protection active
- [ ] JWT secrets securely stored
- [ ] OAuth credentials encrypted
- [ ] Database backups automated
- [ ] VPS firewall configured
- [ ] Only Cloudflare IPs allowed to backend
- [ ] Video links signed & expire
- [ ] Payment receipts validated
- [ ] Admin logs enabled
- [ ] Sensitive data never logged
- [ ] CORS properly configured
- [ ] XSS protections enabled
- [ ] CSRF tokens used
- [ ] SQL injection prevention (ORM)

---

## ğŸ“ Support & Contact

- **GitHub**: https://github.com/yourusername/vietshort
- **Issues**: https://github.com/yourusername/vietshort/issues
- **Documentation**: `/docs` folder
- **Email**: support@yourdomain.com

---

## ğŸ“„ License

MIT License - See LICENSE file

---

## ğŸ™ Contributors

Cáº£m Æ¡n táº¥t cáº£ nhá»¯ng ngÆ°á»i Ä‘Ã³ng gÃ³p cho dá»± Ã¡n nÃ y!

---

## ğŸ“ Má»™t Sá»‘ TÃ i Liá»‡u Há»¯u Ãch

- [NestJS Documentation](https://docs.nestjs.com)
- [Next.js Documentation](https://nextjs.org/docs)
- [Cloudflare Pages](https://pages.cloudflare.com)
- [HLS.js Player](https://github.com/video-dev/hls.js)
- [FFmpeg Video Encoding](https://ffmpeg.org)
- [MySQL Best Practices](https://dev.mysql.com)
- [OAuth 2.0 Flow](https://oauth.net)

---

**Cáº­p nháº­t láº§n cuá»‘i**: 05/02/2026

**PhiÃªn báº£n**: 1.0.0
