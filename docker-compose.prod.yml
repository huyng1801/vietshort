# ============================================
# VietShort - Docker Compose Production Override
# ============================================
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
# ============================================

services:
  # ─── MySQL - Production tuning ──────────────
  mysql:
    command: >
      --default-authentication-plugin=caching_sha2_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --max-connections=500
      --innodb-buffer-pool-size=1G
      --innodb-log-file-size=256M
      --innodb-flush-log-at-trx-commit=1
      --slow-query-log=1
      --long-query-time=1
      --log-queries-not-using-indexes=1
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G

  # ─── Redis - Production tuning ──────────────
  redis:
    command: >
      redis-server
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --requirepass ${REDIS_PASSWORD:-vietshort_redis_pass}
      --save 60 1000
      --save 300 100
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-vietshort_redis_pass}", "--no-auth-warning", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 768M
        reservations:
          memory: 512M

  # ─── Backend - Production build ─────────────
  backend:
    build:
      target: production
    environment:
      NODE_ENV: production      
      FRONTEND_URL: http://${APP_HOST:-localhost}
      ADMIN_CMS_URL: http://${APP_HOST:-localhost}:3002
      API_URL: http://${APP_HOST:-localhost}
      CORS_ORIGIN: http://${APP_HOST:-localhost},http://${APP_HOST:-localhost}:3002
      VNPAY_RETURN_URL: http://${APP_HOST:-localhost}/payment/vnpay/return
      GOOGLE_CALLBACK_URL: http://${APP_HOST:-localhost}/api/v1/auth/google/callback
      FACEBOOK_CALLBACK_URL: http://${APP_HOST:-localhost}/api/v1/auth/facebook/callback
      APPLE_CALLBACK_URL: http://${APP_HOST:-localhost}/api/v1/auth/apple/callback
      TIKTOK_CALLBACK_URL: http://${APP_HOST:-localhost}/api/v1/auth/tiktok/callback    
      volumes: []  # No source mounting in production
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"
        reservations:
          memory: 512M
          cpus: "0.5"
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  # ─── Client - Production build ──────────────
  client:
    build:
      target: production
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: http://${APP_HOST:-localhost}/api/v1
      NEXT_PUBLIC_WS_URL: ws://${APP_HOST:-localhost}
    volumes: []
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
        reservations:
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  # ─── Admin - Production build ───────────────
  admin:
    build:
      target: production
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: http://${APP_HOST:-localhost}
      NEXT_PUBLIC_WS_URL: ws://${APP_HOST:-localhost}
    volumes: []
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
        reservations:
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  # ─── Nginx Reverse Proxy ────────────────────
  nginx:
    image: nginx:alpine
    container_name: vietshort-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - backend
      - client
      - admin
    networks:
      - vietshort-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
