# ============================================
# VietShort - Docker Compose Production Override
# ============================================
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
# ============================================

services:
  # ─── MySQL - Production tuning ──────────────
  mysql:
    command: >
      --default-authentication-plugin=caching_sha2_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --max-connections=500
      --innodb-buffer-pool-size=1G
      --innodb-log-file-size=256M
      --innodb-flush-log-at-trx-commit=1
      --slow-query-log=1
      --long-query-time=1
      --log-queries-not-using-indexes=1
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G

  # ─── Redis - Production tuning ──────────────
  redis:
    command: >
      redis-server
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --requirepass ${REDIS_PASSWORD}
      --save 60 1000
      --save 300 100
    deploy:
      resources:
        limits:
          memory: 768M
        reservations:
          memory: 512M

  # ─── Backend - Production build ─────────────
  backend:
    build:
      target: production
    environment:
      NODE_ENV: production
    volumes: []  # No source mounting in production
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"
        reservations:
          memory: 512M
          cpus: "0.5"
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  # ─── Client - Production build ──────────────
  client:
    build:
      target: production
    environment:
      NODE_ENV: production
    volumes: []
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
        reservations:
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  # ─── Admin - Production build ───────────────
  admin:
    build:
      target: production
    environment:
      NODE_ENV: production
    volumes: []
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
        reservations:
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  # ─── Nginx Reverse Proxy ────────────────────
  nginx:
    image: nginx:alpine
    container_name: vietshort-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - backend
      - client
      - admin
    networks:
      - vietshort-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
